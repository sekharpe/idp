trigger:
  branches:
    include:
    - main
  paths:
    include:
    - containers/*
    - src/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: azure-credentials
  - name: dockerRegistryServiceConnection
    value: 'ACR-Connection'
  - name: imageRepository
    value: 'platform-service'
  - name: containerRegistry
    value: 'cnoedevacr.azurecr.io'
  - name: dockerfilePath
    value: 'containers/platform-services/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build Container Image'
  jobs:
  - job: BuildImage
    displayName: 'Build and Push Image'
    steps:
    - task: Docker@2
      displayName: 'Build Container Image'
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: 'Push Container Image'
      inputs:
        command: push
        repository: $(imageRepository)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: 'Scan Image with Trivy'
      inputs:
        command: 'run'
        arguments: '--rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --severity HIGH,CRITICAL $(containerRegistry)/$(imageRepository):$(tag)'
      continueOnError: true

- stage: UpdateManifest
  displayName: 'Update K8s Manifests'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: UpdateGitOps
    displayName: 'Update GitOps Repository'
    steps:
    - checkout: self
      persistCredentials: true
    
    - script: |
        # Update image tag in Kubernetes manifests
        sed -i 's|image: $(containerRegistry)/$(imageRepository):.*|image: $(containerRegistry)/$(imageRepository):$(tag)|g' gitops/applications/*.yaml
        
        # Commit and push changes
        git config user.email "pipeline@azure.com"
        git config user.name "Azure Pipeline"
        git add gitops/applications/*.yaml
        git commit -m "Update image tag to $(tag) [skip ci]" || echo "No changes to commit"
        git push origin HEAD:main
      displayName: 'Update and Push Manifests'
